# 1.浏览器工作原理及V8引擎

### 1.1浏览器工作原理

- 当用户输入网址时，DNS服务器解析域名，获取真实的服务器IP地址，服务器返回HTML文件
- 浏览器解析HTML文件，形成一颗DOM树，
- 遇到CSS，开启另一个线程，解析CSS文件，形成一颗CSSOM树(CSS规则)，
- 然后两者附加，形成一颗渲染树，再根据layout引擎进行布局，
- 布局结束后到绘制阶段，遍历渲染树并调用渲染对象的paint方法将内容渲染在页面上，要注意的是，这个过程是逐步完成的，它并不会等待整个HTML文档解析完之后再构建和渲染渲染树，它是解析一部分内容就展示一部分内容
- 当碰到JavaScript代码，会暂停解析HTML文档，将控制权移交给JavaScript引擎，等JavaScript引擎运行完毕，浏览器会从暂停的地方再次解析
- 当CSSOM树未加载完成就要执行JavaScript脚本时，浏览器会先加载CSSOM树，然后执行JavaScript代码，最后继续HTML文档解析。



### 1.2常见的浏览器内核

- IE浏览器        Trident
- 火狐浏览器    Gecko
- 谷歌浏览器    Blink
- Safari浏览器 webkit

### 1.3 V8引擎执行过程

当碰到JavaScript代码，V8引擎会对JavaScript代码进行词法分析，将代码转换为tokens的数组，数组中是一个个对象，然后会经过parser和preparser

- parser:直接将tokens转换为AST语法树
- preparser:对函数进行预解析，将需要立即执行的转换为AST语法树，其余代码在调用时再进行转换
接着经过Ignition模块，将AST语法树转换为字节码，然后转为汇编指令，最后转为机器码交给CPU执行
在V8引擎中还有turborFan，用于收集信息，在检测到函数为热函数时，会进行优化，直接转为对应系统的机器码，交给CPU执行，如果代码发生变化，会再次转为字节码。
### 1.4 优化
建议将 script 标签放在 body 标签底部，当然并不是说 script 标签必须放在底部，因为你可以给 script 标签添加 defer 或者 async 属性。
- 没有设置:浏览器会立即加载并执行指定的脚本，也就是说不等待后续载入的文档元素，读到就加载并执行。
- defer:延迟执行引入的 JavaScript，即这段 JavaScript 加载时 HTML 并未停止解析，这两个过程是并行的，当整个document 解析完毕后再执行脚本文件，在 DOMContentLoaded 事件触发之前
完成。多个脚本按顺序执行。

- async 属性表示异步执行引入的 JavaScript，与 defer 的区别在于，如果已经加载好，就会开始执行，也就是说它的执行仍然会阻塞文档的解析，只是它的加载过程不会阻塞。多个脚本的执行顺序无法保证。





